<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="å¹¶å‘Map - sync.Map # æºç åˆ†æ # sync.Mapçš„ç»“æ„ï¼š
type Map struct { mu Mutex // æ’ä»–é”ï¼Œç”¨äºå¯¹dirty mapæ“ä½œæ—¶å€™åŠ é”å¤„ç† read atomic.Value // read map // dirty mapã€‚æ–°å¢keyæ—¶å€™ï¼Œåªå†™å…¥dirty mapä¸­ï¼Œéœ€è¦ä½¿ç”¨mu dirty map[interface{}]*entry // ç”¨æ¥è®°å½•ä»read mapä¸­è¯»å–keyæ—¶missçš„æ¬¡æ•° misses int } sync.Mapç»“æ„ä½“ä¸­readå­—æ®µæ˜¯atomic.Valueç±»å‹ï¼Œåº•å±‚æ˜¯readOnlyç»“æ„ä½“ï¼š
type readOnly struct { m map[interface{}]*entry amended bool // å½“amendedä¸ºtrueæ—¶å€™ï¼Œè¡¨ç¤ºsync.Mapä¸­çš„keyä¹Ÿå­˜åœ¨dirty mapä¸­ } read mapå’Œdirty mapçš„valueç±»å‹æ˜¯*entryï¼Œ entryç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š
// expungedç”¨æ¥æ ‡è®°ä»dirty mapåˆ é™¤æ‰äº† var expunged = unsafe.Pointer(new(interface{})) type entry struct { // å¦‚æœp == nil è¯´æ˜å¯¹åº”çš„entryå·²ç»è¢«åˆ é™¤æ‰äº†ï¼Œ ä¸”m.dirty == nil // å¦‚æœ p == expunged è¯´æ˜å¯¹åº”çš„entryå·²ç»è¢«åˆ é™¤äº†ï¼Œä½†m.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="å¹¶å‘Map - sync.Map" />
<meta property="og:description" content="å¹¶å‘Map - sync.Map # æºç åˆ†æ # sync.Mapçš„ç»“æ„ï¼š
type Map struct { mu Mutex // æ’ä»–é”ï¼Œç”¨äºå¯¹dirty mapæ“ä½œæ—¶å€™åŠ é”å¤„ç† read atomic.Value // read map // dirty mapã€‚æ–°å¢keyæ—¶å€™ï¼Œåªå†™å…¥dirty mapä¸­ï¼Œéœ€è¦ä½¿ç”¨mu dirty map[interface{}]*entry // ç”¨æ¥è®°å½•ä»read mapä¸­è¯»å–keyæ—¶missçš„æ¬¡æ•° misses int } sync.Mapç»“æ„ä½“ä¸­readå­—æ®µæ˜¯atomic.Valueç±»å‹ï¼Œåº•å±‚æ˜¯readOnlyç»“æ„ä½“ï¼š
type readOnly struct { m map[interface{}]*entry amended bool // å½“amendedä¸ºtrueæ—¶å€™ï¼Œè¡¨ç¤ºsync.Mapä¸­çš„keyä¹Ÿå­˜åœ¨dirty mapä¸­ } read mapå’Œdirty mapçš„valueç±»å‹æ˜¯*entryï¼Œ entryç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š
// expungedç”¨æ¥æ ‡è®°ä»dirty mapåˆ é™¤æ‰äº† var expunged = unsafe.Pointer(new(interface{})) type entry struct { // å¦‚æœp == nil è¯´æ˜å¯¹åº”çš„entryå·²ç»è¢«åˆ é™¤æ‰äº†ï¼Œ ä¸”m.dirty == nil // å¦‚æœ p == expunged è¯´æ˜å¯¹åº”çš„entryå·²ç»è¢«åˆ é™¤äº†ï¼Œä½†m." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://go.cyub.vip/concurrency/sync-map/" /><meta property="article:section" content="concurrency" />


<title>å¹¶å‘Map - sync.Map | æ·±å…¥Goè¯­è¨€ä¹‹æ—…</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" >
<link rel="stylesheet" href="/book.min.f06572240ce28e67eb332ac5cf5d59a696c47ad4c6f700d5842c5ed93dd8ec77.css" integrity="sha256-8GVyJAzijmfrMyrFz11ZppbEetTG9wDVhCxe2T3Y7Hc=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.17ed8785d618483565ce5458241250de0bb24d7b931b8b71446036ef43affd37.js" integrity="sha256-F&#43;2HhdYYSDVlzlRYJBJQ3guyTXuTG4txRGA270Ov/Tc=" crossorigin="anonymous"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-BQ229RRTTX"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-BQ229RRTTX', { 'anonymize_ip': false });
}
</script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="https://static.cyub.vip/images/202310/golang-480.png" alt="Logo" /><span>æ·±å…¥Goè¯­è¨€ä¹‹æ—…</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>







  
<ul>
  
  <li>
    <a href="https://www.cyub.vip/"  target="_blank" rel="noopener">
        ä¸ªäººåšå®¢
      </a>
  </li>
  
  <li>
    <a href="https://github.com/cyub"  target="_blank" rel="noopener">
        Githubä¸»é¡µ
      </a>
  </li>
  
  <li>
    <a href="https://www.topgoer.cn/?ref=go.cyub.vip"  target="_blank" rel="noopener">
        åœ°é¼ æ–‡æ¡£
      </a>
  </li>
  
</ul>







  <ul>
<li>
<p><strong>
  <a href="/">æ·±å…¥Goè¯­è¨€ä¹‹æ—…</a></strong></p>
</li>
<li>
<p><strong>å‡†å¤‡ç¯‡</strong></p>
<ul>
<li>
  <a href="/compiler/">ç¼–è¯‘æµç¨‹</a></li>
<li>
  <a href="/analysis-tools/">åˆ†æå·¥å…·</a>
<ul>
<li>
  <a href="/analysis-tools/gdb/">GDB</a></li>
<li>
  <a href="/analysis-tools/dlv/">Delve</a></li>
<li>
  <a href="/analysis-tools/go-buildin-tools/">Go å†…ç½®å·¥å…·</a></li>
</ul>
</li>
<li>
  <a href="/go-assembly/">Goæ±‡ç¼–</a></li>
</ul>
</li>
<li>
<p><strong>åŸºç¡€ç¯‡</strong></p>
<ul>
<li>
  <a href="/type/">æ•°æ®ç±»å‹ä¸æ•°æ®ç»“æ„</a>
<ul>
<li>
  <a href="/type/string/">å­—ç¬¦ä¸²</a></li>
<li>
  <a href="/type/array/">æ•°ç»„</a></li>
<li>
  <a href="/type/slice/">åˆ‡ç‰‡</a></li>
<li>
  <a href="/type/nil/">nil</a></li>
<li>
  <a href="/type/empty_struct/">ç©ºç»“æ„ä½“</a></li>
<li>
  <a href="/type/pointer/">æŒ‡é’ˆ</a></li>
<li>
  <a href="/type/map/">æ˜ å°„</a></li>
</ul>
</li>
<li>
  <a href="/function/">å‡½æ•°</a>
<ul>
<li>
  <a href="/function/first-class/">ä¸€ç­‰å…¬æ°‘</a></li>
<li>
  <a href="/function/call-stack/">å‡½æ•°è°ƒç”¨æ ˆ</a></li>
<li>
  <a href="/function/pass-by-value/">å€¼ä¼ é€’</a></li>
<li>
  <a href="/function/closure/">é—­åŒ…</a></li>
<li>
  <a href="/function/method/">æ–¹æ³•</a></li>
</ul>
</li>
<li>
  <a href="/feature/">è¯­è¨€ç‰¹æ€§</a>
<ul>
<li>
  <a href="/feature/comma-ok/">é€—å·okæ¨¡å¼</a></li>
<li>
  <a href="/feature/for-range/">éå† - for-rangeè¯­æ³•</a></li>
<li>
  <a href="/feature/defer/">å»¶è¿Ÿæ‰§è¡Œ - deferè¯­æ³•</a></li>
<li>
  <a href="/feature/select/">é€šé“é€‰æ‹©å™¨ - selectè¯­æ³•</a></li>
<li>
  <a href="/feature/panic-recover/">ææ…Œä¸æ¢å¤  - panic/recover</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>è¿è¡Œæ—¶ç¯‡</strong></p>
<ul>
<li>
  <a href="/concurrency/">å¹¶å‘ç¼–ç¨‹</a>
<ul>
<li>
  <a href="/concurrency/memory-model/">å†…å­˜æ¨¡å‹</a></li>
<li>
  <a href="/concurrency/context/">ä¸Šä¸‹æ–‡ - context</a></li>
<li>
  <a href="/concurrency/channel/">é€šé“ - channel</a></li>
<li>
  <a href="/concurrency/atomic/">åŸå­æ“ä½œ - atomic</a></li>
<li>
  <a href="/concurrency/sync-map/"class=active>å¹¶å‘Map - sync.Map</a></li>
<li>
  <a href="/concurrency/sync-waitgroup/">ç­‰å¾…ç»„ - sync.WaitGroup</a></li>
<li>
  <a href="/concurrency/sync-once/">ä¸€æ¬¡æ€§æ“ä½œ - sync.Once</a></li>
<li>
  <a href="/concurrency/sync-pool/">ç¼“å†²æ±  - sync.Pool</a></li>
<li>
  <a href="/concurrency/sync-cond/">æ¡ä»¶å˜é‡ - sync.Cond</a></li>
<li>
  <a href="/concurrency/sync-mutex/">äº’æ–¥é” - sync.Mutex</a></li>
<li>
  <a href="/concurrency/sync-rwmutex/">è¯»å†™é” - sync.RWMutex</a></li>
</ul>
</li>
<li>
  <a href="/gmp/">G-M-Pè°ƒåº¦æœºåˆ¶</a>
<ul>
<li>
  <a href="/gmp/gmp-model/">è°ƒåº¦æœºåˆ¶æ¦‚è¿°</a></li>
<li>
  <a href="/gmp/scheduler/">è°ƒåº¦å™¨</a></li>
</ul>
</li>
<li>
  <a href="/memory/">å†…å­˜ç®¡ç†</a>
<ul>
<li>
  <a href="/memory/allocator/">å†…å­˜åˆ†é…å™¨</a></li>
<li>
  <a href="/memory/gc/">GC</a></li>
</ul>
</li>
<li>
  <a href="/type-system/">ç±»å‹ç³»ç»Ÿ</a>
<ul>
<li>
  <a href="/type-system/type/">ç±»å‹ç³»ç»Ÿ</a></li>
<li>
  <a href="/type-system/interface/">æ¥å£</a></li>
<li>
  <a href="/type-system/reflect/">åå°„</a></li>
</ul>
</li>
</ul>
</li>
</ul>










</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>å¹¶å‘Map - sync.Map</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown"><h2 id="å¹¶å‘map---syncmap">
  å¹¶å‘Map - sync.Map
  <a class="anchor" href="#%e5%b9%b6%e5%8f%91map---syncmap">#</a>
</h2>
<h3 id="æºç åˆ†æ">
  æºç åˆ†æ
  <a class="anchor" href="#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90">#</a>
</h3>
<p><strong>sync.Mapçš„ç»“æ„ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Map</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mu</span> <span style="color:#a6e22e">Mutex</span> <span style="color:#75715e">// æ’ä»–é”ï¼Œç”¨äºå¯¹dirty mapæ“ä½œæ—¶å€™åŠ é”å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">read</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Value</span> <span style="color:#75715e">// read map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// dirty mapã€‚æ–°å¢keyæ—¶å€™ï¼Œåªå†™å…¥dirty mapä¸­ï¼Œéœ€è¦ä½¿ç”¨mu
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dirty</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">interface</span>{}]<span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç”¨æ¥è®°å½•ä»read mapä¸­è¯»å–keyæ—¶missçš„æ¬¡æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">misses</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>sync.Mapç»“æ„ä½“ä¸­readå­—æ®µæ˜¯<code>atomic.Value</code>ç±»å‹ï¼Œåº•å±‚æ˜¯<strong>readOnlyç»“æ„ä½“</strong>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">readOnly</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>       <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">interface</span>{}]<span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">amended</span> <span style="color:#66d9ef">bool</span> <span style="color:#75715e">// å½“amendedä¸ºtrueæ—¶å€™ï¼Œè¡¨ç¤ºsync.Mapä¸­çš„keyä¹Ÿå­˜åœ¨dirty mapä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>read mapå’Œdirty mapçš„valueç±»å‹æ˜¯*entryï¼Œ entryç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// expungedç”¨æ¥æ ‡è®°ä»dirty mapåˆ é™¤æ‰äº†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">expunged</span> = <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(new(<span style="color:#66d9ef">interface</span>{}))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">entry</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å¦‚æœp == nil è¯´æ˜å¯¹åº”çš„entryå·²ç»è¢«åˆ é™¤æ‰äº†ï¼Œ ä¸”m.dirty == nil
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  å¦‚æœ p == expunged è¯´æ˜å¯¹åº”çš„entryå·²ç»è¢«åˆ é™¤äº†ï¼Œä½†m.dirty != nilï¼Œä¸”è¯¥entryä¸å­˜åœ¨m.dirtyä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä¸Šè¿°ä¸¤ç§æƒ…å†µå¤–ï¼Œentryåˆ™æ˜¯åˆæ³•çš„å€¼å¹¶ä¸”åœ¨m.read.m[key]ä¸­å­˜åœ¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å¦‚æœm.dirty != nilï¼Œentryä¹Ÿä¼šåœ¨m.dirty[key]ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// pæŒ‡é’ˆæŒ‡å‘sync.Mapä¸­keyå¯¹åº”çš„Value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> <span style="color:#75715e">// *interface{}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>å¯¹Mapçš„æ“ä½œå¯ä»¥åˆ†ä¸ºå››ç±»ï¼š</p>
<ol>
<li>Add key-value æ–°å¢key-value</li>
<li>Update key-value æ›´æ–°keyå¯¹åº”çš„valueå€¼</li>
<li>Get Key-value è·å–Keyå¯¹åº”çš„Valueå€¼</li>
<li>Delete Key åˆ é™¤key</li>
</ol>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹æ–°å¢å’Œæ›´æ–°æ“ä½œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Storeç”¨æ¥æ–°å¢å’Œæ›´æ–°æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Map</span>) <span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">read</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">readOnly</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å¦‚æœread mapå­˜åœ¨è¯¥keyï¼Œä¸”è¯¥keyå¯¹åº”çš„valueä¸æ˜¯expungedæ—¶(å‡†ç¡®çš„è¯´keyå¯¹åº”çš„value, valueæ˜¯*entryç±»å‹ï¼Œentryçš„på­—æ®µæŒ‡å‘ä¸æ˜¯expungedæ—¶)ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// åˆ™ä½¿ç”¨casæ›´æ–°valueï¼Œæ­¤æ“ä½œæ˜¯åŸå­æ€§çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">tryStore</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">value</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>() <span style="color:#75715e">// å…ˆåŠ é”ï¼Œç„¶åé‡æ–°è¯»å–ä¸€æ¬¡read mapï¼Œç›®çš„æ˜¯é˜²æ­¢dirty mapå‡çº§åˆ°read mapï¼ˆå¹¶å‘Loadæ“ä½œæ—¶å€™ï¼‰ï¼Œread mapæ›´æ”¹äº†ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">read</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">readOnly</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#a6e22e">ok</span> { <span style="color:#75715e">// è‹¥read mapå­˜åœ¨æ­¤keyï¼Œæ­¤æ—¶å°±æ˜¯mapçš„æ›´æ–°æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">unexpungeLocked</span>() { <span style="color:#75715e">// å°†valueç”±expungedæ›´æ”¹æˆnilï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// è‹¥æˆåŠŸåˆ™è¡¨æ˜dirty mapä¸­ä¸å­˜åœ¨æ­¤keyï¼ŒæŠŠkey-valueæ·»åŠ åˆ°dirty mapä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span>[<span style="color:#a6e22e">key</span>] = <span style="color:#a6e22e">e</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">storeLocked</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">value</span>) <span style="color:#75715e">// æ›´æ”¹valueã€‚valueæ˜¯æŒ‡é’ˆç±»å‹(*entry)ï¼Œread mapå’Œdirty mapçš„valueéƒ½æŒ‡å‘è¯¥å€¼ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#a6e22e">ok</span> {<span style="color:#75715e">// è‹¥dirty mapå­˜åœ¨è¯¥keyï¼Œåˆ™ç›´æ¥æ›´æ”¹value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">storeLocked</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">value</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> { <span style="color:#75715e">// è‹¥read mapå’Œdirty mapä¸­éƒ½ä¸å­˜åœ¨è¯¥keyï¼Œå…¶å®å°±æ˜¯mapçš„æ–°å¢key-valueæ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">amended</span> {<span style="color:#75715e">// amendedä¸ºtrueæ—¶è¡¨ç¤ºsync.Mapéƒ¨åˆ†keyå­˜åœ¨dirty mapä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// dirtyLocked()åšä¸¤ä»¶äº‹æƒ…ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// 1. è‹¥dirty mapç­‰äºnilï¼Œåˆ™åˆå§‹åŒ–dirty mapã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// 2. éå†read mapï¼Œå°†read mapä¸­çš„key-valueå¤åˆ¶åˆ°dirty mapä¸­ï¼Œä»read mapä¸­å¤åˆ¶çš„key-valueæ—¶ï¼Œvalueæ˜¯nilæˆ–expungedçš„(å› ä¸ºnilå’Œexpungedæ˜¯keyåˆ é™¤äº†çš„ï¼‰ä¸è¿›è¡Œå¤åˆ¶ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// åŒæ—¶è‹¥valueå€¼ä¸ºnilï¼Œåˆ™é¡ºä¾¿æ›´æ”¹æˆexpungedï¼ˆç”¨æ¥æ ‡è®°dirty mapä¸åŒ…å«æ­¤key)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// æ€è€ƒğŸ¤”ï¼šä¸ºå•¥dirtyLocked()è¦å¹²äº‹æƒ…2ï¼Œå³å°†read mapçš„key-valueå¤åˆ¶åˆ°dirty mapä¸­ï¼Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirtyLocked</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// è¯¥æ–°å¢key-valueå°†æ·»åŠ dirty mapä¸­ï¼Œæ‰€ä»¥å°†read mapçš„amendedè®¾ç½®ä¸ºtrueã€‚å½“amendedä¸ºtrueæ—¶å€™ï¼Œä»sync.Mapè¯»å–keyæ—¶å€™ï¼Œä¼˜å…ˆä»read mapä¸­è¯»å–ï¼Œè‹¥read mapè¯»å–æ—¶å€™ä¸åˆ°æ—¶å€™ï¼Œä¼šä»dirty mapä¸­è¯»å–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">readOnly</span>{<span style="color:#a6e22e">m</span>: <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">m</span>, <span style="color:#a6e22e">amended</span>: <span style="color:#66d9ef">true</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ·»åŠ key-valueåˆ°dirty mapä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span>[<span style="color:#a6e22e">key</span>] = <span style="color:#a6e22e">newEntry</span>(<span style="color:#a6e22e">value</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// é‡Šæ”¾é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>) <span style="color:#a6e22e">tryStore</span>(<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">expunged</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">i</span>)) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>) <span style="color:#a6e22e">unexpungeLocked</span>() (<span style="color:#a6e22e">wasExpunged</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">expunged</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>) <span style="color:#a6e22e">storeLocked</span>(<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">StorePointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">i</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Map</span>) <span style="color:#a6e22e">dirtyLocked</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">read</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">readOnly</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">interface</span>{}]<span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>, len(<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">m</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">m</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">tryExpungeLocked</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span>[<span style="color:#a6e22e">k</span>] = <span style="color:#a6e22e">e</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>) <span style="color:#a6e22e">tryExpungeLocked</span>() (<span style="color:#a6e22e">isExpunged</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">p</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">expunged</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span> = <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">expunged</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ¥ä¸‹æ¥çœ‹çœ‹Mapçš„Getæ“ä½œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Loadæ–¹æ³•ç”¨æ¥è·å–keyå¯¹åº”çš„valueå€¼ï¼Œè¿”å›çš„okè¡¨åkeyæ˜¯å¦å­˜åœ¨sync.Mapä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Map</span>) <span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">read</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">readOnly</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">key</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">amended</span> { <span style="color:#75715e">// è‹¥keyä¸å­˜åœ¨read mapä¸­ï¼Œä¸”dirty mapåŒ…å«sync.Mapä¸­keyæƒ…å†µä¸‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>() <span style="color:#75715e">// åŠ é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">read</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">readOnly</span>) <span style="color:#75715e">// å†æ¬¡ä»read mapè¯»å–key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> = <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">key</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">amended</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span>[<span style="color:#a6e22e">key</span>] <span style="color:#75715e">// ä»dirty mapä¸­è¯»å–key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// missLocked() é¦–å…ˆå°†missesè®¡æ•°åŠ 1ï¼Œmissesç”¨æ¥è¡¨æ˜read mapè¯»å–keyæ²¡æœ‰å‘½ä¸­çš„æ¬¡æ•°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// è‹¥missesæ¬¡æ•°å¤šäºdirty mapä¸­å…ƒç´ ä¸ªæ•°æ—¶å€™ï¼Œåˆ™å°†dirty mapå‡çº§ä¸ºread mapï¼Œdirty mapè®¾ç½®ä¸ºnil, amendedç½®ä¸ºfalse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">missLocked</span>()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> { <span style="color:#75715e">// read map å’Œ dirty mapä¸­éƒ½ä¸å­˜åœ¨è¯¥key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åŠ è½½valueå€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">load</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>) <span style="color:#a6e22e">load</span>() (<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">expunged</span> { <span style="color:#75715e">// è‹¥valueå€¼æ˜¯nilæˆ–expungedï¼Œè¿”å›nil, falseï¼Œè¡¨ç¤ºkeyä¸å­˜åœ¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#66d9ef">interface</span>{})(<span style="color:#a6e22e">p</span>), <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Map</span>) <span style="color:#a6e22e">missLocked</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">misses</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">misses</span> &lt; len(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ–°åˆ›å»ºä¸€ä¸ªreadOnlyå¯¹è±¡ï¼Œå…¶ä¸­amendedä¸ºfalse, å¹¶å°†m.dirtyç›´æ¥èµ‹å€¼ç»™è¯¥å¯¹è±¡çš„må­—æ®µï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¿™ä¹Ÿæ˜¯ä¸Šé¢æ€è€ƒä¸­çš„dirtyLockedä¸ºä»€ä¹ˆè¦å¹²äº‹æƒ…2çš„åŸå› ï¼Œå› ä¸ºé€šè¿‡2æ“ä½œä¹‹åï¼Œm.dirtyå·²åŒ…å«read mapä¸­çš„æ‰€æœ‰keyï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥åˆ›å»ºreadOnlyã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">readOnly</span>{<span style="color:#a6e22e">m</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">misses</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åœ¨æ¥ç€çœ‹çœ‹Mapçš„åˆ é™¤æ“ä½œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Deleteç”¨äºåˆ é™¤key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Map</span>) <span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">read</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">readOnly</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">key</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">amended</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">read</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">readOnly</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> = <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">key</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// è‹¥read mapä¸å­˜åœ¨è¯¥keyï¼Œä½†dirty mapä¸­å­˜åœ¨è¯¥keyã€‚åˆ™ç›´æ¥è°ƒç”¨deleteï¼Œåˆ é™¤dirty mapä¸­è¯¥key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">amended</span> {
</span></span><span style="display:flex;"><span>			delete(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span>, <span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.delete()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>) delete() (<span style="color:#a6e22e">hadValue</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">expunged</span> { <span style="color:#75715e">// è‹¥entryä¸­på·²ç»æ˜¯nilæˆ–è€…expungedåˆ™ç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">p</span>, <span style="color:#66d9ef">nil</span>) { <span style="color:#75715e">// å°†entryä¸­çš„pè®¾ç½®ä¸ºnil
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>sync.Mapè¿˜æä¾›éå†key-valueåŠŸèƒ½ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Rangeæ–¹æ³•æ¥å—ä¸€ä¸ªè¿­ä»£å›è°ƒå‡½æ•°ï¼Œç”¨æ¥å¤„ç†éå†çš„keyå’Œvalue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Map</span>) <span style="color:#a6e22e">Range</span>(<span style="color:#a6e22e">f</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">read</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">readOnly</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">amended</span> { <span style="color:#75715e">// è‹¥dirty mapä¸­åŒ…å«sync.Mapä¸­keyæ—¶å€™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">read</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#a6e22e">readOnly</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">amended</span> {<span style="color:#75715e">// åŠ é”ä¹‹åï¼Œå†æ¬¡åˆ¤æ–­ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢å¹¶å‘è°ƒç”¨Loadæ–¹æ³•æ—¶å€™ï¼Œdirty mapå‡çº§ä¸ºread mapæ—¶å€™ï¼Œamendedä¸ºfalseæƒ…å†µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// read.amendedä¸ºtrueçš„æ—¶å€™ï¼Œm.dirtyåŒ…å«sync.Mapä¸­æ‰€æœ‰çš„key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">read</span> = <span style="color:#a6e22e">readOnly</span>{<span style="color:#a6e22e">m</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span>}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">read</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">dirty</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">misses</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">read</span>.<span style="color:#a6e22e">m</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">load</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span>) { <span style="color:#75715e">//æ‰§è¡Œè¿­ä»£å›è°ƒå‡½æ•°ï¼Œå½“è¿”å›falseæ—¶å€™ï¼Œåœæ­¢è¿­ä»£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="ä¸ºä»€ä¹ˆä¸ä½¿ç”¨syncmutexmapå®ç°å¹¶å‘çš„mapå‘¢">
  ä¸ºä»€ä¹ˆä¸ä½¿ç”¨sync.Mutex+mapå®ç°å¹¶å‘çš„mapå‘¢ï¼Ÿ
  <a class="anchor" href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e4%bd%bf%e7%94%a8syncmutexmap%e5%ae%9e%e7%8e%b0%e5%b9%b6%e5%8f%91%e7%9a%84map%e5%91%a2">#</a>
</h3>
<p>è¿™ä¸ªé—®é¢˜å¯ä»¥æ¢ä¸ªé—®æ³•å°±æ˜¯sync.Mapç›¸æ¯”sync.Mutex+mapå®ç°å¹¶å‘mapæœ‰å“ªäº›ä¼˜åŠ¿ï¼Ÿ</p>
<p>sync.Mapä¼˜åŠ¿åœ¨äºå½“keyå­˜åœ¨read mapæ—¶å€™ï¼Œå¦‚æœè¿›è¡ŒStoreæ“ä½œï¼Œå¯ä»¥ä½¿ç”¨åŸå­æ€§æ“ä½œæ›´æ–°ï¼Œè€Œsync.Mutex+mapå½¢å¼æ¯æ¬¡å†™æ“ä½œéƒ½è¦åŠ é”ï¼Œè¿™ä¸ªæˆæœ¬æ›´é«˜ã€‚</p>
<p>å¦å¤–å¹¶å‘è¯»å†™ä¸¤ä¸ªä¸åŒçš„keyæ—¶å€™ï¼Œå†™æ“ä½œéœ€è¦åŠ é”ï¼Œè€Œè¯»æ“ä½œæ˜¯ä¸éœ€è¦åŠ é”çš„ã€‚</p>
<h3 id="è¯»å°‘å†™å¤šæƒ…å†µä¸‹å¹¶å‘mapåº”è¯¥æ€ä¹ˆè®¾è®¡">
  è¯»å°‘å†™å¤šæƒ…å†µä¸‹å¹¶å‘mapï¼Œåº”è¯¥æ€ä¹ˆè®¾è®¡ï¼Ÿ
  <a class="anchor" href="#%e8%af%bb%e5%b0%91%e5%86%99%e5%a4%9a%e6%83%85%e5%86%b5%e4%b8%8b%e5%b9%b6%e5%8f%91map%e5%ba%94%e8%af%a5%e6%80%8e%e4%b9%88%e8%ae%be%e8%ae%a1">#</a>
</h3>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨åˆ†ç‰‡é”ï¼Œè·Ÿæ®keyè¿›è¡Œhashå¤„ç†åï¼Œæ‰¾åˆ°å…¶å¯¹åº”è¯»å†™é”ï¼Œç„¶åè¿›è¡Œé”å®šå¤„ç†ã€‚é€šè¿‡åˆ†ç‰‡é”æœºåˆ¶ï¼Œå¯ä»¥é™ä½é”çš„ç²’åº¦æ¥å®ç°è¯»å°‘å†™å¤šæƒ…å†µä¸‹é«˜å¹¶å‘ã€‚å¯ä»¥å‚è§
  <a href="https://github.com/orcaman/concurrent-map">orcaman/concurrent-map</a>å®ç°ã€‚</p>
<h3 id="æ€»ç»“">
  æ€»ç»“
  <a class="anchor" href="#%e6%80%bb%e7%bb%93">#</a>
</h3>
<ul>
<li>sync.Mapæ˜¯ä¸èƒ½å€¼ä¼ é€’ï¼ˆç‹­ä¹‰çš„ï¼‰çš„</li>
<li>sync.Mapé‡‡ç”¨ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ã€‚å…¶åº•å±‚ç»“æ„å­˜åœ¨ä¸¤ä¸ªmapï¼Œåˆ†åˆ«æ˜¯read mapå’Œdirty mapã€‚å½“è¯»å–æ“ä½œæ—¶å€™ï¼Œä¼˜å…ˆä»read mapä¸­è¯»å–ï¼Œæ˜¯ä¸éœ€è¦åŠ é”çš„ï¼Œè‹¥keyä¸å­˜åœ¨read mapä¸­æ—¶å€™ï¼Œå†ä»dirty mapä¸­è¯»å–ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŠ é”çš„ã€‚å½“æ–°å¢keyæ“ä½œæ—¶å€™ï¼Œåªä¼šå°†æ–°å¢keyæ·»åŠ åˆ°dirty mapä¸­ï¼Œæ­¤æ“ä½œæ˜¯åŠ é”çš„ï¼Œä½†ä¸ä¼šå½±å“read mapçš„è¯»æ“ä½œã€‚å½“æ›´æ–°keyæ“ä½œæ—¶å€™ï¼Œå¦‚æœkeyå·²å­˜åœ¨read mapä¸­æ—¶å€™ï¼Œåªéœ€æ— é”æ›´æ–°æ›´æ–°read mapå°±è¡Œï¼Œè´Ÿè´£åŠ é”å¤„ç†åœ¨dirty mapä¸­æƒ…å†µäº†ã€‚æ€»ä¹‹sync.Mapä¼šä¼˜å…ˆä»read mapä¸­è¯»å–ã€æ›´æ–°ã€åˆ é™¤ï¼Œå› ä¸ºå¯¹read mapçš„è¯»å–ä¸éœ€è¦é”</li>
<li>å½“sync.Mapè¯»å–keyæ“ä½œæ—¶å€™ï¼Œè‹¥ä»read mapä¸­ä¸€ç›´æœªè¯»åˆ°ï¼Œè‹¥dirty mapä¸­å­˜åœ¨read mapä¸­ä¸å­˜åœ¨çš„keysæ—¶ï¼Œåˆ™ä¼šæŠŠdirty mapå‡çº§ä¸ºread mapï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŠ é”çš„ã€‚è¿™æ ·ä¸‹æ¬¡è¯»å–æ—¶å€™åªéœ€è¦è€ƒè™‘ä»read mapè¯»å–ï¼Œä¸”è¯»å–è¿‡ç¨‹æ˜¯æ— é”çš„</li>
<li>å»¶è¿Ÿåˆ é™¤æœºåˆ¶ï¼Œåˆ é™¤ä¸€ä¸ªé”®å€¼æ—¶åªæ˜¯æ‰“ä¸Šåˆ é™¤æ ‡è®°ï¼Œåªæœ‰åœ¨æå‡dirty mapä¸ºread mapçš„æ—¶å€™æ‰æ¸…ç†åˆ é™¤çš„æ•°æ®</li>
<li>sync.Mapä¸­çš„dirty mapè¦ä¹ˆæ˜¯nilï¼Œè¦ä¹ˆåŒ…å«read mapä¸­æ‰€æœ‰æœªåˆ é™¤çš„key-valueã€‚</li>
<li>sync.Mapé€‚ç”¨äºè¯»å¤šå†™å°‘åœºæ™¯ã€‚æ ¹æ®
  <a href="https://golang.org/pkg/sync/#Map">åŒ…å®˜æ–¹æ–‡æ¡£ä»‹ç»</a>ï¼Œå®ƒç‰¹åˆ«é€‚åˆè¿™ä¸¤ä¸ªåœºæ™¯ï¼š1. ä¸€ä¸ªkeyåªå†™å…¥ä¸€æ¬¡ä½†è¯»å–å¤šæ¬¡æ—¶ï¼Œæ¯”å¦‚åœ¨åªä¼šå¢é•¿çš„ç¼“å­˜ä¸­ï¼›2. å½“å¤šä¸ªgoroutineè¯»å–ã€å†™å…¥å’Œæ›´æ–°ä¸ç›¸äº¤çš„é”®å€¼å¯¹æ—¶ã€‚</li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

<script src="https://giscus.app/client.js" data-repo="cyub/go-1.14.13"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzMzc2ODUyMzQ=" data-category="Announcements"
    data-category-id="DIC_kwDOFCCq8s4CZ3BC"
    data-mapping="pathname" data-strict="0" data-emit-metadata="0"
    data-input-position="bottom" data-reactions-enabled="0"
    data-lang="zh-CN" data-theme="preferred_color_scheme" crossorigin="anonymous" async>
    </script>
<noscript>Please enable JavaScript to view the comments powered by giscus.</noscript>
</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
</body>
</html>












